<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>测试微信网页授权</title>
</head>
<body>
<h1>授权成功！</h1>
</body>
<script src="public/scripts/jquery-1.12.1.min.js"></script>
<script src="public/scripts/utils/httpUtil.js"></script>
<!-- 微信分享api -->
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script>
    var Http;
    window.onload = function(){
       var code = request('code');
        Http = new Http('http://api.bobo119.com/api/');
        Http.ajaxRequest({uri:'wx/userInfo/'+code,'success':function(json){
            if(json.success){
                var data = json.data;
                alert('nickname :' + data.nickname + ' openid:' + data.openid);
            }
        }});
        getSingPackage();
    }

    function request(paras){
        var url = location.search;
        var paraString = url.substring(url.indexOf("?")+1,url.length).split("&");
        var paraObj = {};
        for (i=0; j=paraString[i]; i++){
            paraObj[j.substring(0,j.indexOf("=")).toLowerCase()] = j.substring(j.indexOf("=")+1,j.length);
        }
        var returnValue = paraObj[paras.toLowerCase()];
        if(typeof(returnValue)=="undefined"){
            return "";
        }else{
            return returnValue;
        }
    }

    /**
     * 微信分享
     */
    var title ='0元起拍，开瑞K60心动“价”到，任性开走'; // 分享标题
    var link ='https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx91b9ea7e64becfbb&redirect_uri=http%3a%2f%2fwx.bjczxda.com%2findex.html&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect';
    var desc = '快乐家庭7座SUV-开瑞K60震撼上市( 全网直播进行中)'; // 分享描述

    function getSingPackage(){
        var p ='url='+ escape(location.href);
        Http.ajaxRequest({uri:'wx/signature',datas:p,success:function(rt){
            if (rt.success) {
                var data = rt.data;
                $("input[name=appId]").val(data.appId);
                $('input[name=timestamp]').val(data.timestamp);
                $('input[name=nonceStr]').val(data.nonceStr);
                $('input[name=signature]').val(data.signature);
                runShare(null,null);
            }
        }});
    }


    function runShare(pTitle, pDesc){

        title = !pTitle?title:pTitle;
        desc = !pDesc?desc:pDesc;

        wx.config({
            debug: false,
            appId: $("input[name=appId]").val(),
            timestamp:$('input[name=timestamp]').val(),
            nonceStr: $('input[name=nonceStr]').val(),
            signature: $('input[name=signature]').val(),
            jsApiList: [
                'onMenuShareTimeline',
                'onMenuShareAppMessage',
                'onMenuShareQQ',
                'onMenuShareWeibo'
                // 所有要调用的 API 都要加到这个列表中
            ]
        });
        wx.ready(function () {
            //alert($('#shareWeixinImg').attr('src'));
            // 在这里调用 API

            wx.onMenuShareTimeline({
                title:title, // 分享标题
                link: link, // 分享链接
                desc: desc, // 分享描述
                imgUrl:imgUrl, // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });

            wx.onMenuShareAppMessage({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link: link, // 分享链接
                imgUrl: imgUrl, // 分享图标
                type: '', // 分享类型,music、video或link，不填默认为link
                dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });

            wx.onMenuShareQQ({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link: link, // 分享链接
                imgUrl: imgUrl, // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });

            wx.onMenuShareWeibo({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link: link, // 分享链接
                imgUrl: imgUrl, // 分享图标
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });

        });
    }
</script>
</html>